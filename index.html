<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mathquiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="">mathquiz</h1>
    <h2 id="stato" ></h2>
    <div id="links" class="mb-2">
      <a id="inizia" href="" class="btn btn-primary mr-2">Inizia</a>
      <a id="ricomincia" href="" class="btn btn-secondary mr-2 d-none">Ricomincia</a>
      <span id="timer"></span>
    </div>
    <div id="operazioni"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="domanda" tabindex="-1" aria-labelledby="domandaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="domandaLabel">Domanda</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="content fs-1 mb-4"></div> 
          <input type="text" class="form-control" id="risposta" placeholder="">
        </div>
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
          <button id="conferma" type="button" class="btn btn-primary">Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    let ok = ko = 0;
    let numeroOperazioni;
    let numeroMassimoSommeSottrazioni;
    let secondiMaxPerOperazione;
    let count;
    let domanda = new bootstrap.Modal(document.getElementById('domanda'), {});
    let risultato;
    let operatore;
    const operatori = ["+","-","*","/"];
    let operazione;
    let numero1;
    let numero2;
    let inizioTimer;
    let intervalloTimer;
    let domandaModal = new bootstrap.Modal(document.getElementById('domanda'), {});

    document.getElementById("inizia").addEventListener("click", (e) => {
      e.preventDefault();
      setup();
    })

    document.getElementById("conferma").addEventListener("click", (e) => {
      e.preventDefault();
      leggiRisposta();
    })


    document.addEventListener('keyup', (event) => {
      const keyName = event.key;
      if (event.keyCode === 13) {
        console.log("enter pressed");
        if(!document.getElementById('domanda').classList.contains("show")) document.getElementById("conferma").click();
      }
    }, false);

    

    const setup = () => {
      document.getElementById("inizia").classList.toggle('d-none');
      setTimeout(()=>{
        numeroOperazioni = parseInt(window.prompt("quante operazioni vuoi?", 10));
        numeroMassimoSommeSottrazioni = parseInt(window.prompt("per + e - numeri grandi fino a...", 100));
        numeroMassimoMoltipliceEDivisioni = parseInt(window.prompt("per * e / secondo operatore grande fino a ...", 3));
        secondiMaxPerOperazione = parseInt(window.prompt("tempo massimo per operazione in secondi?", 10));
        inizia();
      }, 100)
    }

    const inizia = () => {
      document.getElementById("inizia").classList.toggle('d-none');
      document.getElementById("ricomincia").classList.toggle('d-none');
      count = numeroOperazioni;
      faiDomanda();
    }

    const ricomincia = () => {
      ok = ko = 0;
      document.getElementById("inizia").classList.toggle('d-none');
      document.getElementById("ricomincia").classList.toggle('d-none');
      document.getElementById("operazioni").replaceChildren();
      inizia();
    }

    const timerRisposta = () => {
      fineTimer =  moment().add(secondiMaxPerOperazione, 'seconds');
      intervalloTimer = setInterval(()=>{
        const tempoRimanente = moment(fineTimer-moment()).format("mm:ss");
        const stingaTimer = `tempo rimanente ${tempoRimanente}s`;
        document.getElementById("timer").innerText = stingaTimer;
        //console.log(stingaTimer);
      }, 100)
      setTimeout(()=>{
        document.getElementById("conferma").click();
        clearInterval(intervalloTimer);
      }, secondiMaxPerOperazione*1000)
    }

    const calcolaRisultato = () => {
      operazione = `${numero1}${operatore}${numero2}`;
      risultato = eval(operazione).toFixed(1);
    }
    
    const faiDomanda = () => {
      operatore = operatori[Math.floor(Math.random()*operatori.length)];
      const operatore1Massimo = numeroMassimoSommeSottrazioni;
      const operatore2Massimo = ["+","-"].indexOf(operatore) != -1 ? numeroMassimoSommeSottrazioni : numeroMassimoMoltipliceEDivisioni
      numero1 = Math.round(Math.random()*operatore1Massimo);
      numero2 = Math.round(Math.random()*operatore2Massimo);
      if(operatore == "/" && numero1<numero2) [numero1, numero2] = [numero2, numero1]
      if(operatore == "/") {
        calcolaRisultato();
        const resto = risultato % 1;
        if(resto > 0) {
          numero2 = (numero1 % numero2)*numero2;
        }
        if(numero2==0) numero2 =1;
      }
      calcolaRisultato();
      //const risposta = window.prompt(`${operazione} = ?`)
      document.querySelector("#domanda .content").innerText = operazione;
      document.querySelector("#risposta").value = "";
      if(!document.getElementById('domanda').classList.contains("show")) domandaModal.show({
        backdrop: 'static',
        keyboard: true,
      });
      document.querySelector("#risposta").focus();
      console.log(`${operazione} = ${risultato}`);
      inizioTimer = moment();
      timerRisposta();
    }

    const leggiRisposta = () => {
      const risposta = document.querySelector("#risposta").value;
      mostraRisposta(operazione, risultato, risposta);
      aggiornaStato();
      count --;
      if(count>0) {
        setTimeout(() => faiDomanda(), 0);
      } else {
        domandaModal.hide();
        clearInterval(intervalloTimer);
      }
    }

    const mostraRisposta = (operazione, risultato, risposta ) => {
      let classeRisposta = "bg-success";
      if(parseFloat(risposta) == risultato){
        ok ++;
      } else {
        ko ++;
        classeRisposta = "bg-danger";
      }
      const html = `
        <div class="row mb-2">
          <div class="col-12">${operazione} = <span class="badge ${classeRisposta}">${risposta}</span></div>
        </div>
      `;
      document.getElementById("operazioni").insertAdjacentHTML('afterend', html);
    }

    const aggiornaStato = () => {
      const percentuale = (ok/numeroOperazioni*100).toFixed()
      document.getElementById("stato").innerText = `indovinate ${ok} su ${numeroOperazioni}, pari a ${percentuale}%`;
    }
  </script>
</body>
</html>