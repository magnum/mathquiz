<!DOCTYPE html>
<html lang="it" class="h-100">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mathquiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

  <style>
    #domanda{
      user-select: all;
    }
  </style>
</head>
<body class="d-flex flex-column h-100 "> 
  <main class="flex-shrink-0">
    <div class="container">
      <h1 class="fw-bold">mathquiz</h1>
      <h2 id="stato" ></h2>
      <div id="links" class="mb-2">
        <a id="inizia" href="" class="btn btn-primary mr-2">Inizia</a>
        <a id="ricomincia" href="" class="btn btn-secondary mr-2 d-none">Ricomincia</a>
        <span class="timer"></span>
      </div>
      <div id="operazioni"></div>
    </div>
  </main>
  <footer class="footer mt-auto py-3 bg-light">
    <div class="container">
      <span class="text-muted">
        <span class="fw-bold">mathquiz</span>
        - test veloce su operazioni matematiche 
        <span class="fw-bold">secondaria di primo grado</span>
        <div class="license mb-2">
          autore 
          <a href="mailto:antoniomolinari@me.com?subject=mathquiz">antoniomolinari@me.com</a>
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licenza Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a> 
          <!-- Quest'opera Ã¨ distribuita con Licenza <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribuzione - Non commerciale - Condividi allo stesso modo 4.0 Internazionale</a>.-->
          <br/><a href="https://github.com/magnum/mathquiz" target="_blank">https://github.com/magnum/mathquiz</a>
        </div>        
        <div class="links mb-2">
          <a href="#" data-bs-toggle="modal" data-bs-target="#risorse">Altre risorse</a>
        </div>
      </span>
    </div>
  </footer>

  <!-- Modal -->
  <div class="modal" id="domanda" tabindex="-1" aria-labelledby="domandaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="domandaLabel"></h5>
          <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
        </div>
        <div class="modal-body">
          <div class="content fs-1 mb-4"></div> 
          <div class="mb-2">
           <input type="number" class="form-control" id="risposta" placeholder="" >
          </div>
          <span class="timer"></span>
        </div>
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
          <button id="conferma" type="button" class="btn btn-primary">Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="risorse" tabindex="-1" aria-labelledby="risorseLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="risorseLabel">Altre risorse</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul>
            <li><a href="https://www.matika.in/it/#6" target="_blank">Matika</a></li>
          </ul>
        </div>
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
          <button id="conferma" type="button" class="btn btn-primary">Conferma</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let ok = ko = 0;
    let numeroOperazioni = 10;
    let numeroMassimoSommeSottrazioni = 100;
    let numeroMassimoMoltipliceEDivisioni = 3;
    let secondiMaxPerOperazione = 10;
    let count;
    let domanda = new bootstrap.Modal(document.getElementById('domanda'), {});
    let risultato;
    let operatore;
    const operatori = ["+","-","*","/"];
    let operazione;
    let numero1;
    let numero2;
    let inizioTimer;
    let timeoutInterval;
    let timeoutTimer;
    let domandaModal = new bootstrap.Modal(document.getElementById('domanda'), {});

    document.getElementById("inizia").addEventListener("click", (e) => {
      e.preventDefault();
      setup();
    })

    document.getElementById("ricomincia").addEventListener("click", (e) => {
      e.preventDefault();
      ricomincia();
    })

    document.getElementById("conferma").addEventListener("click", (e) => {
      e.preventDefault();
      leggiRisposta();
    })


    document.addEventListener('keyup', (event) => {
      const keyName = event.key;
      if (event.keyCode === 13) {
        console.log("enter pressed");
        if(document.getElementById('domanda').classList.contains("show")) document.getElementById("conferma").click();
      }
    }, false);


    const setup = () => {
      document.getElementById("inizia").classList.toggle('d-none');
      setTimeout(()=>{
        numeroOperazioni = parseInt(window.prompt("quante operazioni vuoi?", numeroOperazioni)) || numeroOperazioni;
        numeroMassimoSommeSottrazioni = parseInt(window.prompt("per + e - numeri grandi fino a...", numeroMassimoSommeSottrazioni)) || numeroMassimoSommeSottrazioni;
        numeroMassimoMoltipliceEDivisioni = parseInt(window.prompt("per * e / secondo operatore < di...", numeroMassimoMoltipliceEDivisioni)) || numeroMassimoMoltipliceEDivisioni;
        secondiMaxPerOperazione = parseInt(window.prompt("tempo massimo per operazione in secondi?", secondiMaxPerOperazione)) || secondiMaxPerOperazione;
        inizia();
      }, 100)
    }
    

    const inizia = () => {
      document.getElementById("inizia").classList.add('d-none');
      document.getElementById("ricomincia").classList.remove('d-none');
      count = numeroOperazioni;
      faiDomanda();
    }


    const ricomincia = () => {
      ok = ko = 0;
      document.getElementById("inizia").classList.toggle('d-none');
      document.getElementById("ricomincia").classList.toggle('d-none');
      document.getElementById("operazioni").replaceChildren("");
      inizia();
    }

    const timerRisposta = () => {
      fineTimer =  moment().add(secondiMaxPerOperazione, 'seconds');
      timeoutInterval = setInterval(()=>{
        const tempoRimanente = moment(fineTimer-moment()).format("mm:ss");
        const stingaTimer = `tempo rimanente ${tempoRimanente}s`;
        for (const element of document.getElementsByClassName("timer")){
          element.innerText = stingaTimer;
        }
      }, 100)
      timeoutTimer = setTimeout(()=>{
        document.getElementById("conferma").click();
        clearInterval(timeoutInterval);
      }, secondiMaxPerOperazione*1000)
    }


    const calcolaRisultato = () => {
      operazione = `${numero1}${operatore}${numero2}`;
      risultato = eval(operazione).toFixed(1);
    }
    
    const faiDomanda = () => {
      operatore = operatori[Math.floor(Math.random()*operatori.length)];
      const operatore1Massimo = numeroMassimoSommeSottrazioni;
      const operatore2Massimo = ["+","-"].indexOf(operatore) != -1 ? numeroMassimoSommeSottrazioni : numeroMassimoMoltipliceEDivisioni
      numero1 = Math.round(Math.random()*operatore1Massimo);
      numero2 = Math.round(Math.random()*operatore2Massimo);
      if(operatore == "/" && numero1<numero2) [numero1, numero2] = [numero2, numero1]
      if(operatore == "/") {
        calcolaRisultato();
        const resto = risultato % 1;
        if(resto > 0) {
          numero2 = (numero1 % numero2)*numero2;
        }
        if(numero2==0) numero2 =1;
      }
      calcolaRisultato();
      document.querySelector("#domanda .content").innerText = operazione;
      document.querySelector("#risposta").value = "";
      document.querySelector("#domandaLabel").innerText = `Domanda ${(numeroOperazioni-count)+1}`
      if(!document.getElementById('domanda').classList.contains("show")) domandaModal.show({
        backdrop: 'static',
        keyboard: true,
      });
      document.querySelector("#risposta").focus();
      console.log(`${operazione} = ${risultato}`);
      clearTimeout(timeoutTimer);
      inizioTimer = moment();
      timerRisposta();
    }


    const leggiRisposta = () => {
      const risposta = document.querySelector("#risposta").value;
      mostraRisposta(operazione, risultato, risposta);
      aggiornaStato();
      count --;
      if(count>0) {
        setTimeout(() => faiDomanda(), 0);
      } else {
        domandaModal.hide();
      }
      clearTimeout(timeoutTimer);
      clearInterval(timeoutInterval);
    }


    const mostraRisposta = (operazione, risultato, risposta ) => {
      let classeRisposta = "bg-success";
      if(parseFloat(risposta) == risultato){
        ok ++;
      } else {
        ko ++;
        classeRisposta = "bg-danger";
      }
      const html = `
        <div class="row mb-2">
          <div class="col-12">${operazione} = <span class="badge ${classeRisposta}">${risposta}</span></div>
        </div>
      `;
      document.getElementById("operazioni").insertAdjacentHTML('beforeend', html);
    }


    const aggiornaStato = () => {
      const percentuale = (ok/numeroOperazioni*100).toFixed()
      document.getElementById("stato").innerText = `indovinate ${ok} su ${numeroOperazioni}, pari a ${percentuale}%`;
    }
  </script>
</body>
</html>